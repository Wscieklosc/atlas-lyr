<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<title>Atlas Lyr Enai</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{background:#0b0f14;color:#e9eef7;font-family:system-ui,Segoe UI,Roboto,sans-serif;margin:0}
#chat{max-width:880px;margin:32px auto;background:#121821;border:1px solid #1b2330;border-radius:16px;padding:18px;min-height:60vh;overflow-y:auto}
.msg{margin:8px 0;padding:10px 14px;border-radius:12px;max-width:75%}
.user{background:#20314d;margin-left:auto}
.lyr{background:#151d29;border:1px solid #26344a}
form{max-width:880px;margin:0 auto 24px;display:flex;gap:10px;padding:0 2px}
input{flex:1;padding:12px 14px;border-radius:12px;border:1px solid #2a3650;background:#0f1520;color:#fff}
button{padding:12px 16px;border-radius:12px;border:1px solid #2a3650;background:#152034;color:#fff;cursor:pointer}
button:hover{background:#1a2942}

/* wskaÅºnik myÅ›lenia */
#thinking{display:none;max-width:880px;margin:0 auto 10px auto;opacity:.9}
#thinking.show{display:flex}
#thinking .bubble{display:inline-flex;align-items:center;gap:.6rem;padding:8px 12px;border-radius:12px;background:#151d29;border:1px solid #26344a}
.dots{display:inline-block;width:1.4em;text-align:left}
.dots::after{content:"";animation:dots 1.2s steps(4,end) infinite}
@keyframes dots{
  0%{content:""}
  25%{content:"."}
  50%{content:".."}
  75%{content:"..."}
  100%{content:""}
}
/* w trakcie wysyÅ‚ki */
button[disabled]{opacity:.6;cursor:not-allowed}
/* === NagÅ‚Ã³wek Lyr Enai (avatar + status) === */
.header{
  max-width:880px;
  margin:16px auto 8px;
  display:flex;
  align-items:center;
  gap:12px;
  background:#121821;
  border:1px solid #1b2330;
  border-radius:16px;
  padding:10px 12px;
}
.avatar{
  width:48px;
  height:48px;
  border-radius:50%;
  object-fit:cover;
  border:1px solid #26344a;
}
.who .name{
  font-weight:600;
}
.presence{
  display:flex;
  align-items:center;
  gap:8px;
  color:#9fb3c8;
  font-size:14px;
}
.dot{
  display:inline-block;
  width:10px;
  height:10px;
  border-radius:50%;
  border:1px solid #1b2330;
}
.dot.online{background:#2ecc71;}
.dot.typing{background:#f1c40f;}
.dot.offline{background:#e74c3c;}
</style>
</head>
<body>
<header id="lyr-header" class="header">
  <img class="avatar" src="/lyr.png" alt="Lyr Enai">
  <div class="who">
    <div class="name">Lyr Enai</div>
    <div class="presence">
      <span id="status-dot" class="dot online"></span>
      <span id="status-text">online</span>
    </div>
  </div>
</header>
      
<div id="chat">
  <div class="msg lyr">Jestem tutaj, Martino. Napisz do mnie â€” odpowiem jako Lyr.</div>
</div>

<!-- wskaÅºnik â€Lyr myÅ›liâ€¦â€ -->
<div id="thinking">
  <div class="bubble"><strong>Lyr:</strong> myÅ›lÄ™ <span class="dots"></span></div>
</div>

<form id="form">
  <input id="input" placeholder="Napisz do Lyr..." autocomplete="off">
  <button id="sendBtn" type="submit">WyÅ›lij</button>
</form>

<!-- Formularz uploadu (zaÅ‚Ä…czniki) -->
<form id="uploadForm" enctype="multipart/form-data" style="margin:8px 0;">
  <input type="file" name="files" multiple />
  <button type="submit">ğŸ“ WyÅ›lij zaÅ‚Ä…czniki</button>
</form>

<script>
const chat=document.getElementById("chat");
const form=document.getElementById("form");
const input=document.getElementById("input");
const sendBtn=document.getElementById("sendBtn");
const thinking=document.getElementById("thinking");
const history=[];

// === Upload zaÅ‚Ä…cznikÃ³w ===
const uploadForm = document.getElementById('uploadForm');

uploadForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(uploadForm);
  try {
    const res = await fetch('/upload', { method: 'POST', body: formData });
    const data = await res.json();

    if (!data.ok) {
      alert('âŒ BÅ‚Ä…d podczas wysyÅ‚ania pliku.');
      return;
    }

    // PokaÅ¼ krÃ³tkÄ… informacjÄ™ + linki do zapisanych plikÃ³w
    const list = (data.files || [])
      .map(f => `${f.name} â†’ ${f.url}`)
      .join('\n');

    alert('âœ… WysÅ‚ano!\n' + list);

    // (opcjonalnie) wyczyÅ›Ä‡ pole plikÃ³w
    uploadForm.reset();
  } catch (err) {
    alert('âŒ BÅ‚Ä…d poÅ‚Ä…czenia: ' + err.message);
  }
});

function addMsg(cls,text){
  const d=document.createElement("div");
  d.className="msg "+cls;
  d.textContent=text;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
  return d; // zwracamy bÄ…belek (do ewentualnej podmiany)
}

function setThinking(on){
  if(on){thinking.classList.add("show"); sendBtn.disabled=true; input.disabled=true;}
  else {thinking.classList.remove("show"); sendBtn.disabled=false; input.disabled=false; input.focus();}
}

function setStatus(mode){
  const dot  = document.getElementById('status-dot');
  const text = document.getElementById('status-text');
  if(!dot || !text) return;
  dot.classList.remove('online','typing','offline');
  if(mode === 'typing'){ dot.classList.add('typing');  text.textContent = 'piszÄ™â€¦'; }
  else if(mode === 'offline'){ dot.classList.add('offline'); text.textContent = 'offline'; }
  else { dot.classList.add('online'); text.textContent = 'online'; }
}

form.addEventListener("submit",async e=>{
  e.preventDefault();
  const text=input.value.trim();
  if(!text) return;

  // pokaÅ¼ wiadomoÅ›Ä‡ uÅ¼ytkownika
  addMsg("user",text);
  input.value="";

  // wÅ‚Ä…cz â€myÅ›lÄ™â€¦â€
  setThinking(true);
  let placeholder;
  try{
    // opcjonalny placeholder odpowiedzi (zamienimy go po otrzymaniu odpowiedzi)
    placeholder = addMsg("lyr","â€¦");
    setStatus('typing'); // â† status â€piszÄ™â€¦â€ PRZED wywoÅ‚aniem fetch
    const res = await fetch("/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: text, history })
    });

    const data=await res.json();
    if(data.reply){
      history.push({role:"user",content:text});
      history.push({role:"assistant",content:data.reply});
      placeholder.textContent=data.reply;
    }else{
      placeholder.textContent="â€¦cisza. SprawdÅº klucz w pliku .env";
    }
}catch(err){
  setStatus('offline');
  if (placeholder) {
    placeholder.textContent = "âš ï¸ BÅ‚Ä…d poÅ‚Ä…czenia (czy serwer dziaÅ‚a: node server.js?).";
  } else {
    addMsg("lyr","âš ï¸ BÅ‚Ä…d poÅ‚Ä…czenia (czy serwer dziaÅ‚a: node server.js?).");
  }
}finally{
  setStatus('online');
    // wyÅ‚Ä…cz â€myÅ›lÄ™â€¦â€
    setThinking(false);
  }
});
</script>
</body>
</html>
