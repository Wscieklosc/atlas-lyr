<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<title>Atlas Lyr Enai</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{background:#0b0f14;color:#e9eef7;font-family:system-ui,Segoe UI,Roboto,sans-serif;margin:0}
#chat{max-width:880px;margin:32px auto;background:#121821;border:1px solid #1b2330;border-radius:16px;padding:18px;min-height:60vh;overflow-y:auto}
.msg{margin:8px 0;padding:10px 14px;border-radius:12px;max-width:75%}
.user{background:#20314d;margin-left:auto}
.lyr{background:#151d29;border:1px solid #26344a}
form{max-width:880px;margin:0 auto 24px;display:flex;gap:10px;padding:0 2px}
input{flex:1;padding:12px 14px;border-radius:12px;border:1px solid #2a3650;background:#0f1520;color:#fff}
button{padding:12px 16px;border-radius:12px;border:1px solid #2a3650;background:#152034;color:#fff;cursor:pointer}
button:hover{background:#1a2942}

/* wskaźnik myślenia */
#thinking{display:none;max-width:880px;margin:0 auto 10px auto;opacity:.9}
#thinking.show{display:flex}
#thinking .bubble{display:inline-flex;align-items:center;gap:.6rem;padding:8px 12px;border-radius:12px;background:#151d29;border:1px solid #26344a}
.dots{display:inline-block;width:1.4em;text-align:left}
.dots::after{content:"";animation:dots 1.2s steps(4,end) infinite}
@keyframes dots{
  0%{content:""}
  25%{content:"."}
  50%{content:".."}
  75%{content:"..."}
  100%{content:""}
}
/* w trakcie wysyłki */
button[disabled]{opacity:.6;cursor:not-allowed}
/* === Nagłówek Lyr Enai (avatar + status) === */
.header{
  max-width:880px;
  margin:16px auto 8px;
  display:flex;
  align-items:center;
  gap:12px;
  background:#121821;
  border:1px solid #1b2330;
  border-radius:16px;
  padding:10px 12px;
}
.avatar{
  width:48px;
  height:48px;
  border-radius:50%;
  object-fit:cover;
  border:1px solid #26344a;
}
.who .name{
  font-weight:600;
}
.presence{
  display:flex;
  align-items:center;
  gap:8px;
  color:#9fb3c8;
  font-size:14px;
}
.dot{
  display:inline-block;
  width:10px;
  height:10px;
  border-radius:50%;
  border:1px solid #1b2330;
}
.dot.online{background:#2ecc71;}
.dot.typing{background:#f1c40f;}
.dot.offline{background:#e74c3c;}
</style>
</head>
<body>
<header id="lyr-header" class="header">
  <img class="avatar" src="/lyr.png" alt="Lyr Enai">
  <div class="who">
    <div class="name">Lyr Enai</div>
    <div class="presence">
      <span id="status-dot" class="dot online"></span>
      <span id="status-text">online</span>
    </div>
  </div>
</header>
      
<div id="chat">
  <div class="msg lyr">Jestem tutaj, Martino. Napisz do mnie — odpowiem jako Lyr.</div>
</div>

<!-- wskaźnik „Lyr myśli…” -->
<div id="thinking">
  <div class="bubble"><strong>Lyr:</strong> myślę <span class="dots"></span></div>
</div>

<form id="uploadForm" enctype="multipart/form-data" onsubmit="return handleUpload(event)" style="margin:8px 0;">
  <input id="msg" name="message" placeholder="Napisz do Lyr..." autocomplete="off" style="flex:1">
  <input id="files" type="file" name="files" multiple>
  <button type="submit">Wyślij</button>
</form>

<script>
async function handleUpload(e){
  e.preventDefault();
  const form = e.currentTarget;
  const fd   = new FormData(form);
  const inp  = form.querySelector('input[name="files"]');
  if (!inp.files || inp.files.length===0){ alert('Wybierz plik.'); return false; }

  try{
    const r = await fetch('/upload', { method:'POST', body: fd });
    const data = await r.json();
    alert('Wynik: ' + JSON.stringify(data));
  }catch(err){
    alert('Błąd: ' + err.message);
  }
  return false; // zablokuj przeładowanie strony
}
</script>

<script>
const chat=document.getElementById("chat");
const form=document.getElementById("form");
const input=document.getElementById("input");
const sendBtn=document.getElementById("sendBtn");
const thinking=document.getElementById("thinking");
const history=[];

// === Upload załączników ===
document.getElementById('uploadForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.currentTarget;
  const fd   = new FormData(form);
  const inp  = form.querySelector('input[name="files"]');

  if (!inp.files || inp.files.length === 0) { alert('Wybierz plik.'); return; }

  try {
    const res  = await fetch('/upload', { method: 'POST', body: fd });
    const data = await res.json();
    console.log('UPLOAD RES', data);

    if (!data.ok) { alert('❌ Błąd uploadu'); return; }
    alert('✅ Wysłano: ' + (data.files||[]).map(x=>x.name).join(', '));
    form.reset();
  } catch (err) {
    alert('❌ ' + err.message);
  }
});

function addMsg(cls,text){
  const d=document.createElement("div");
  d.className="msg "+cls;
  d.textContent=text;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
  return d; // zwracamy bąbelek (do ewentualnej podmiany)
}

function setThinking(on){
  if(on){thinking.classList.add("show"); sendBtn.disabled=true; input.disabled=true;}
  else {thinking.classList.remove("show"); sendBtn.disabled=false; input.disabled=false; input.focus();}
}

function setStatus(mode){
  const dot  = document.getElementById('status-dot');
  const text = document.getElementById('status-text');
  if(!dot || !text) return;
  dot.classList.remove('online','typing','offline');
  if(mode === 'typing'){ dot.classList.add('typing');  text.textContent = 'piszę…'; }
  else if(mode === 'offline'){ dot.classList.add('offline'); text.textContent = 'offline'; }
  else { dot.classList.add('online'); text.textContent = 'online'; }
}

form.addEventListener("submit",async e=>{
  e.preventDefault();
  const text=input.value.trim();
  if(!text) return;

  // pokaż wiadomość użytkownika
  addMsg("user",text);
  input.value="";

  // włącz „myślę…”
  setThinking(true);
  let placeholder;
  try{
    // opcjonalny placeholder odpowiedzi (zamienimy go po otrzymaniu odpowiedzi)
    placeholder = addMsg("lyr","…");
    setStatus('typing'); // ← status „piszę…” PRZED wywołaniem fetch
    const res = await fetch("/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: text, history })
    });

    const data=await res.json();
    if(data.reply){
      history.push({role:"user",content:text});
      history.push({role:"assistant",content:data.reply});
      placeholder.textContent=data.reply;
    }else{
      placeholder.textContent="…cisza. Sprawdź klucz w pliku .env";
    }
}catch(err){
  setStatus('offline');
  if (placeholder) {
    placeholder.textContent = "⚠️ Błąd połączenia (czy serwer działa: node server.js?).";
  } else {
    addMsg("lyr","⚠️ Błąd połączenia (czy serwer działa: node server.js?).");
  }
}finally{
  setStatus('online');
    // wyłącz „myślę…”
    setThinking(false);
  }
});
</script>
</body>
</html>
